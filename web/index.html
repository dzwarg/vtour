<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ext="http://www.extjs.com/">
<head>
  <title>vTour</title>

  <!-- ExtJS scripts -->
  <link rel="stylesheet" type="text/css" href="ext-2.0.2/resources/css/ext-all.css" />
  <link rel="stylesheet" type="text/css" href="ext-2.0.2/resources/css/xtheme-gray.css" />
  <style type="text/css">
    body { font-family: 'Tahoma','Arial','Helvetica','sans-serif'; }
  </style>
  <script type="text/javascript" src="ext-2.0.2/adapter/ext/ext-base.js"></script>
  <script type="text/javascript" src="ext-2.0.2/ext-all.js"></script>
  <script type="text/javascript" src="FlickrPagingToolbar.js"></script>
  <script type="text/javascript" src="json2.js"></script>
  <script type="text/javascript">
    Ext.BLANK_IMAGE_URL = 's.gif';
    var vtour = {
      flickrkey:'FLICKR-KEY',
      fsurl:'http://www.spondubone.net/fs/featureserver.cgi'
    }

    Ext.onReady(function(){

      var state = new Ext.state.CookieProvider();
      Ext.state.Manager.setProvider( state );
      
      var welcomeTemplate = new Ext.Template( 'Welcome, {0}' );
      var TourRecord = Ext.data.Record.create([ 'name', 'id', 'bbox' ]);
      var myTourStore = new Ext.data.SimpleStore({
        fields: [ 'name', 'id', 'bbox' ],
        data: []
      });

      var fixDate = function(d) {
        if ( d==null ) return null;
        var m=d.match(/(\d+)-(\d+)-(\d+)/);
        m=Date.parse(m[2] + '/' + m[3] + '/' + m[1]);
        return new Date(m);
      };
      
      var addSearchToDisplay = function(searches, detailFinish) {
        var index = 0;
        var addSearchToDisplay2 = function(comp){
          if ( index < searches.length ) {
            if ( comp ) {
              var dom = comp.getEl().dom;
              var imgs = Ext.DomQuery.select( 'img', dom );
              var paging = Ext.DomQuery.select( 'div.x-paging-info', dom );

              if ( paging.length == 0 ) {
                setTimeout( function(){ addSearchToDisplay2(comp); }, 100 );
                return;
              }

              if( imgs.length == 0 && !paging[0].innerHTML.match( /No images.*/ ) ) {
                setTimeout( function(){ addSearchToDisplay2(comp); }, 100 );
                return;
              }
            }

            var prjBounds = vtour.projectBounds( searches[index].geometry.getBounds(), true );
            var constraints = {
              perPage: Math.floor(vtour.results.activeTab.el.getWidth()/93),
              fromdate: fixDate(searches[index].attributes[ 'fromdate' ]),
              todate: fixDate(searches[index].attributes[ 'todate' ]),
              tags: searches[index].attributes[ 'tags' ]
            };
            
            index++;
            vtour.getFlickrPhotos( prjBounds.toBBOX(), searches[index-1], constraints );
          }
          else {
            vtour.results.un('render',addSearchToDisplay2,window);
            
            detailFinish(searches);
          }
        };

        return addSearchToDisplay2;
      };

      var addResultToDisplay = function(searches){
        var addResultToDisplay2 = function(idx){
          if ( idx >= searches.length )
            return;

          new OpenLayers.Ajax.Request(vtour.fsurl + '/result?queryable=search' +
            '&search='+searches[idx].fid+'&format=geojson', {
            method: 'get',
            requestHeaders: ['Accept','application/json'],
            asynchronous: true,
            onSuccess: function(xhr) {
              var results = vtour.geojson.read( xhr.responseText, 'FeatureCollection' );

              for ( var i = 0; i < results.length; i++ ) {
                results[i].geometry.transformed = false;
                var newGeom = results[i].geometry.transform(
                  vtour.ol_map.projection, vtour.ol_map.displayProjection );
                var detail = {
                  tags: 'some tags',
                  position: { lon: newGeom.x, lat: newGeom.y },
                  image: (function(img){
                    var i = new Image();
                    i.src = img;
                    return i;
                  })(results[i].attributes['thumb_url']),
                  title: results[i].attributes['name'],
                  imageid: 'image id',
                  owner: 'owner id'
                };

                var comp = vtour.results.getComponent(idx+1);
                vtour.showDetail( detail, comp.el.id );
              }

              setTimeout( function(){ addResultToDisplay2(idx+1); }, 100 );
            }
          });
        };
        addResultToDisplay2(0);
      }

      var tourCombo = new Ext.form.ComboBox({
        store: myTourStore,
        displayField: 'name',
        mode: 'local',
        triggerAction: 'all',
        emptyText: 'Select Tour...',
        width: 145,
        fieldLabel: 'Tour',
        labelStyle: 'padding-left:2px;width:43px;',
        valueNotFoundText: 'Loading...',
        editable: false,
        sortInfo: { field: 'name', direction: 'ASC' },
        listeners: {
          select: function(combo,record,index) {
            while (vtour.results.getComponent(1) != null) {
              vtour.results.remove( vtour.results.getComponent(1) );
            }

            new OpenLayers.Ajax.Request(vtour.fsurl + '/search?queryable=tour' +
              '&tour='+record.get('id')+'&format=geojson', {
              method: 'get', 
              requestHeaders: ['Accept', 'application/json'],
              asynchronous: true,
              onSuccess: function( xhr ){
                var searches = vtour.geojson.read( xhr.responseText, 'FeatureCollection' );

                for( var i = 0; i < searches.length; i++ ) {
                  searches[i].attributes.searchElem = '';
                  searches[i].style = {
                    fillColor: '#fff',
                    fillOpacity: 0.2,
                    strokeColor: '#333',
                    strokeOpacity: 0.5,
                    strokeWidth: 1,
                    strokeLinecap: 'round'
                  }
                }

                var addSearch = addSearchToDisplay(searches, addResultToDisplay);

                vtour.results.on('render',addSearch,window);

                // add this search feature to the map
                vtour.ol_layers['features'].addFeatures(searches);

                addSearch( null );
              }
            });
          }
        }
      });

      var loggedInPanel = new Ext.FormPanel({
        title:'My Account',
        collapsed: false,
        labelWidth: 43,
        items: [
          new Ext.Panel({
            id: 'welcomePanel',
            border:false,
            html: '',
            style: 'margin:0px 0px 5px 0px; padding: 2px;'
          }),
          tourCombo
        ]
      });
      
      var loginPanel = new Ext.FormPanel({
        title:'Sign In',
        collapsed: false,
        defaultType: 'textfield',
        labelWidth: 63,
        labelAlign: 'right',
        items: [
          new Ext.Panel({
            border: false,
            html: 'Sign in, or register to start saving your tours.',
            style: 'margin:0px 0px 5px 0px; padding: 2px;'
          }),
          {
            fieldLabel: 'Login',
            name: 'user',
            width: 125,
            vtype: 'alphanum',
            allowBlank: false
          }, {
            inputType:'password',
            fieldLabel: 'Password',
            name: 'password',
            width: 125,
            allowBlank: false
          }
        ],
        method: 'GET',
        url: '/~davidz/users/login'
      });

      loginPanel.addButton({
        text: 'Sign In',
        handler: function() {
          var frm = loginPanel.getForm();
          if ( frm.isValid() ) {
            frm.submit({
              waitMsg:'Logging in...',
              failure: function( form, action ) {
                if ( action.result.message != 'ok' ) {
                  Ext.MessageBox.alert( 'Oops!', action.result.message );
                  return;
                }
                
                loginPanel.hide();
                loginPanel.getForm().reset();
                loggedInPanel.show();
                
                // save auth cookie
                state.set( 'vtour_secret', action.result.secret );
                state.set( 'vtour_user', action.result.user.login );
                state.set( 'vtour_userid', action.result.user.id );
                
                Ext.get('welcomePanel').update( welcomeTemplate.apply( [action.result.user.login] ) );

                tourCombo.setValue( 'Loading...' );

                // get all tours owned by this user
                new OpenLayers.Ajax.Request(vtour.fsurl + '/tour?queryable=user_id' +
                  '&user_id='+action.result.user.id + '&format=geojson', {
                  method: 'get', 
                  requestHeaders: ['Accept', 'application/json'],
                  asynchronous: true,
                  onSuccess: function( xhr ){
                    var tours = vtour.geojson.read( xhr.responseText, 'FeatureCollection' );

                    var tourRecs = [];
                    var tourState = [];
                    for ( var i = 0; i < tours.length; i++ ) {
                      tourRecs.push( new TourRecord({
                        name: tours[i].attributes.name,
                        id: tours[i].fid,
                        bbox: tours[i].geometry.getBounds().toBBOX()
                      }) );

                      tourState.push( tours[i].fid + ':' + tours[i].attributes.name );
                    }

                    myTourStore.add( tourRecs );
                    state.set( 'vtour_tours', tourState.join(';') );

                    tourCombo.reset();
                  }
                });
              }
            });
          }
        }
      });
      
      var registerWin;

      loginPanel.addButton({
        text: 'Register',
        handler: function() {
          if ( !registerWin ) {
            var registerForm = new Ext.FormPanel({
              border: false,
              collapsible: false,
              bodyStyle:'padding:2px 2px 2px 2px;',
              method:'POST',
              url:'/~davidz/users/register',
              items: [
                new Ext.form.FieldSet({
                  title: 'Pick a login',
                  labelAlign: 'right',
                  labelWidth: 63,
                  height: 53,
                  defaultType: 'textfield',
                  items: [{
                    fieldLabel: 'Login', 
                    name: 'user', 
                    width: 125,
                    vtype: 'alphanum',
                    allowBlank: false                    
                  }]
                }),
                new Ext.form.FieldSet({
                  title: 'Pick a good password',
                  labelAlign: 'right',
                  labelWidth: 63,
                  height: 80,
                  defaultType: 'textfield',
                  items:[{ 
                    fieldLabel: 'Password', 
                    name: 'password', 
                    width: 125,
                    inputType: 'password',
                    allowBlank: false
                  },{ 
                    fieldLabel: 'Verify', 
                    name: 'password2', 
                    width: 125,
                    inputType: 'password',
                    allowBlank: false
                  }]
                }),
                new Ext.form.FieldSet({
                  title: 'Finally, your email address',
                  labelAlign: 'right',
                  labelWidth: 63,
                  height: 80,
                  defaultType: 'textfield',
                  items: [{
                    fieldLabel: 'Email', 
                    name: 'email', 
                    width: 125,
                    vtype: 'email',
                    allowBlank: false
                  },{ 
                    fieldLabel: 'Verify', 
                    name: 'email2', 
                    width: 125,
                    vtype: 'email',
                    allowBlank: false
                  }]
                })
              ]
            });
            
            registerWin = new Ext.Window({
              title: 'Register an account',
              modal: true,
              closeAction: 'hide',
              items:[
                registerForm
              ],
              buttons: [
                new Ext.Button({ 
                  text: 'Register',
                  handler: function() {
                    var frm = registerForm.getForm();
                    if ( frm.findField('password').el.getValue() != frm.findField('password2').el.getValue() ) {
                      frm.markInvalid([{
                        id: 'password',
                        msg: 'Passwords must match.'
                      },{
                        id: 'password2',
                        msg: 'Passwords must match.'
                      }]);
                      return;
                    }
                    if (frm.findField('email').el.getValue() != frm.findField('email2').el.getValue() ) {
                      frm.markInvalid([{
                        id: 'email',
                        msg: 'Email addresses must match.'
                      },{
                        id: 'email2',
                        msg: 'Email addresses must match.'
                      }]);
                      return;                      
                    }
                    if ( frm.isValid() ) {
                      frm.submit({
                        waitMsg:'Registering...',
                        failure: function( form, action ) {
                          if ( action.result.message != 'ok' ) {
                            if ( action.result.message == 'A user with that name already exists.' ) {
                              registerForm.getForm().markInvalid( [{
                                id:'user',
                                msg: action.result.message
                              }] );
                            }
                            else
                              Ext.MessageBox.alert( 'Oops!', action.result.message );
                          }
                          else {
                            registerForm.getForm().reset();
                            registerWin.hide();
                          }
                        }
                      });
                    }
                  }
                }),
                new Ext.Button({
                  text: 'Cancel',
                  handler: function() {
                    registerForm.getForm().reset();
                    registerWin.hide();
                  }
                })
              ]
            });
          }

          registerWin.show();
        }
      });

      loggedInPanel.addButton({
        text: 'Sign Out',
        handler: function() {
          // clear cookies
          state.clear( 'vtour_secret' );
          state.clear( 'vtour_user' );
          state.clear( 'vtour_userid' );
          state.clear( 'vtour_tours' );

          myTourStore.removeAll();
                        
          loggedInPanel.hide();
          loginPanel.show();
        }
      });

      vtour.datePanel = new Ext.form.FormPanel({
        formId: 'dateRangeFrm',
        collapsed: true,
        title: 'Date Range',
        labelWidth: 63,
        labelAlign: 'right',
        defaultType: 'datefield',
        bodyStyle: 'margin:0px;padding:2px;',
        items: [{
          name: 'fromDate',
          allowBlank: false,
          width: 60,
          fieldLabel: 'From',
          value: (function(){
            var d=new Date();
            d = new Date(d.valueOf() + 24*60*60*1000);
            d.setFullYear( d.getFullYear()-1 );
            return d;
          })(),
          maxValue: new Date(),
          minValue: (function(){
            var d = new Date();
            d.setFullYear( d.getFullYear()-1 );
            return d;
          })()
        },{
          name: 'toDate',
          allowBlank: false,
          width: 60,
          fieldLabel: 'To',
          value: new Date(),
          maxValue: new Date(),
          minValue: (function(){
            var d = new Date();
            d.setFullYear( d.getFullYear()-1 );
            return d;
          })()
        }]
      });

      vtour.tagPanel = new Ext.form.FormPanel({
	formId: 'tagForm',
	collapsed: true,
	title: 'Tag Filter',
	labelWidth: 63,
	labelAlign: 'right',
	defaultType: 'textfield',
	bodyStyle: 'margin:0px;padding:2px;',
	items:[{
	  name: 'tagFilter',
	  allowBlank: true,
	  width: 125,
	  fieldLabel: 'Tags'
	}]
      });
      
      var eastPanel = new Ext.Panel({
        region:'east',
        id:'eastPanel',
        width:200,
        defaults: {
          // applied to each contained panel
          collapsible:true,
          border:false
        },
        items:[
          { title:'Map Layers',
            contentEl:'mapLayerSwitcherPanel',
            collapsed: false,
            bodyStyle: 'margin:0px;' },
          loginPanel,
          loggedInPanel,
          {
            title:'Search Distance',
            contentEl:'searchPanel',
            collapsed: true,
            bodyStyle: 'margin:0px;'
          },
          vtour.datePanel,
	  vtour.tagPanel
        ]
      });

      var firstPanelSwitch = function(panel,instr){
        var loggedin = state.get( 'vtour_user', '' ) !== '';
	if ( loggedin && instr ) {
	  panel.setTitle( 'Tour Options' );
	  panel.items.get(0).hide();
	  panel.items.get(1).show();
	}
	else {
	  panel.setTitle( 'Instructions' );
	  panel.items.get(0).show();
	  panel.items.get(1).hide();
	}
      };

      var saveResultHandler = function( userId, attributes ) {
        return function( resp ) {
          var search = vtour.geojson.read( resp.responseText, 'FeatureCollection' );

          // loop through all markers, and process only the ones in the search
          var markers = vtour.ol_layers['markers'].features;
          for ( var i = 0; i < markers.length; i++ ) {
            if ( markers[i].attributes.searchElem == attributes.searchElem )
              // todo: add thumb_url, image_url, name
              vtour.saveResult( userId, 
                search[0].fid,
                markers[i].attributes.searchDetail,
                markers[i].geometry, 
                function(r){}, 
                function(r){
                  Ext.MessageBox.alert( 'Oops', 'Could not save result' );
                }
              );
          }
        };
      };

      var saveSearchHandler = function( userId ) {
        return function( resp ) {
          var tour = vtour.geojson.read( resp.responseText, 'FeatureCollection' );

          var boxes = vtour.ol_layers['features'].features;
          for ( var i = 0; i < boxes.length; i++ ) {
            vtour.saveSearch( userId, tour[0].fid,
              boxes[i],
              saveResultHandler( userId, boxes[i].attributes ),
              function( resp ) {
                Ext.MessageBox.alert( 'Oops', 'Could not save searches' );
              }
            )
          }

          // disable save button, indicate that the tour has been saved
          tourSaveBtn.enable();
          tourSaveBtn.setText('Save');

          Ext.MessageBox.alert( 'Yay!', 'Your tour has been saved.' );

          var tRec = new TourRecord({ 
            name: tour[0].attributes.name, 
            id: tour[0].fid,
            bbox: tour[0].geometry.getBounds().toBBOX()
          });
          myTourStore.add( [tRec] );
          var tourSet = state.get( 'vtour_tours', '' );
          tourSet += tRec.get('id') + ':' + tRec.get('name');
          state.set( 'vtour_tours', tourSet );
        };
      };

      var saveTourHandler = function(frm){
        return function( btn, evt ) {
          if ( !frm.isValid() ) return;

          var tourName = frm.findField('name').getValue();
          if ( tourName === '' ) {
            frm.findField('name').markInvalid();
            return;
          }

          // disable the button
          btn.disable();
          btn.setText('Saving...');

          var id = state.get( 'vtour_userid', 0 );
          vtour.saveTour( id, tourName, new Date(),
            saveSearchHandler( id ),
            function( resp ){
              Ext.MessageBox.alert( 'Oops',
                'Error saving tour, please try again later.' );
            }
          );
        };
      };

      var tourNameField = new Ext.form.TextField({
        name: 'name',
        width: 200,
        invalidText: 'Enter a name for the tour. Each tour must have a unique name.',
        validator: function( newVal ) {
          if ( newVal === '' ) return false;

          var valid = false;

          new OpenLayers.Ajax.Request(vtour.fsurl + '/tour?queryable=name,user_id' +
            '&name='+newVal+'&user_id='+state.get('vtour_userid')+'&format=geojson', {
            method: 'get', 
            requestHeaders: ['Accept', 'application/json'],
            asynchronous: false,
            onSuccess: function( xhr ){ 
              var resp = vtour.geojson.read( xhr.responseText, 'FeatureCollection' );
              valid = (resp.length === 0); 
            }
          });

          return valid;
        }
      });

      var tourSaveBtn = new Ext.Button({
        style: 'padding-left:2px;',
        width: 100,
        text: 'Save'
      });
      
      var tourMgmtPanel = new Ext.form.FormPanel({
	// provide tour management
	border: false,
	bodyStyle: 'padding:2px;',
	items:[
          new Ext.Panel({
            title: 'Save',
            collapsible: true,
            layout: 'column',
            width: 700,
            items:[
              {
                style: 'padding: 2px 0px 0px 2px;',
                width: 400,
                border: false,
                html: 'To save this tour, enter a name and click "Save".'
              },
              tourNameField,
              tourSaveBtn
            ]
          }),
          new Ext.Panel({
            title: 'Delete',
            collapsible: true,
            layout: 'column',
            width: 700,
            items:[
              {
                style: 'padding: 2px 0px 0px 2px;',
                width: 400,
                border: false,
                html: 'To delete this tour, click "Delete".'
              },
              {
                border: false,
                width: 200,
                html: '&nbsp;'
              },
              new Ext.Button({
                text: 'Delete',
                style: 'padding-left:2px;',
                width: 100,
                handler: function( btn ){
                  while (vtour.results.getComponent(1) != null) {
                    vtour.results.remove( vtour.results.getComponent(1) );
                  }
                }
              })
            ]
          })
	]
      });

      tourSaveBtn.on('click', saveTourHandler( tourMgmtPanel.getForm() ) );

      vtour.results = new Ext.TabPanel({
        id:'resultTabs',
        visible: false,
        height: 170,
        border: false,
        activeTab: 0,
        enableTabScroll: true,
        defaults: { 
          autoScroll: true, 
          closable: true
        },
        items: [{ 
          title: 'Instructions', 
          closable: false,
	  items: [{
	    border: false,
	    contentEl: 'south'
	  }, tourMgmtPanel ]
        }],
        listeners: {
          'beforeremove': function( me, child ){
            var i = me.items.findIndex( 'id', child.id );
	    vtour.ol_layers['features'].removeFeatures(
	      vtour.ol_layers['features'].features.slice( i-1, i )
	    );
              
	    for ( var j = vtour.ol_layers['markers'].features.length - 1; j >= 0; j-- ) {
	      var feature = vtour.ol_layers['markers'].features[j];
	      if ( feature.attributes.searchElem == child.id ) {
		vtour.ol_layers['markers'].removeFeatures( [feature] );
	      }
	    }

	    firstPanelSwitch( me.items.get(0), me.items.getCount()>2 );
          },
	  'add': function( me, child, idx ) {
	    firstPanelSwitch( me.items.get(0), idx > 0 );
	  }
        }
      });

      // setup the viewport
      var viewport = new Ext.Viewport({
        layout:'border',
        items:[{
          region:'center',
          deferredRender:false,
          contentEl:'center',
          margins:'0 0 0 0',
          border: false
        },
        eastPanel,{
          region:'south',
          id:'searchPanelDiv',
          collapsible:false,
          split:false,
          height:170,
          margins:'0 0 0 0',
          border: false,
          items:[
            vtour.results
          ]
        }]
      });
      
      // hide the logged-in status until after logging in
      if ( state.get( 'vtour_user', '' ) == '' ) {
        loggedInPanel.hide();
      }
      else {
        loginPanel.hide();

        Ext.get('welcomePanel').update( welcomeTemplate.apply( [state.get('vtour_user')] ) );

        var tourState = state.get( 'vtour_tours', '' ).split(/;/);
        var tours = [];
        for ( var i = 0; i < tourState.length; i++ ) {
          var tInfo = tourState[i].split(/:/);
          tours.push( new TourRecord( { id: tInfo[0], name: tInfo[1] } ) );
        }

        myTourStore.add( tours );
      }

      viewport.on( {
        'resize': function( obj, adjWidth, adjHeight, rawWidth, rawHeight ){ 
          if ( ol_resize ) {
	    vtour.setMapHeight();
            ol_resize();
          }
        }
      });

      // add the click handler to the results item
      Ext.fly(vtour.results.el.id).on( 'click',function( e ) {
        e.stopEvent();
        var target = e.getTarget('div.thumb');
        if ( target ) {
          var detail = {
            tags: target.getAttribute( 'ext:tags' ),
            position: {
              lon: parseFloat(target.getAttribute( 'ext:position' ).split(',')[0]),
              lat: parseFloat(target.getAttribute( 'ext:position' ).split(',')[1])
            },
            image: (function(img){
	      var i = new Image();
	      i.src = img;
	      return i;
	    })(target.getAttribute( 'ext:image' ) ),
            title: target.getAttribute( 'ext:title' ),
	    imageid: target.getAttribute( 'ext:imageid' ),
	    owner: target.getAttribute( 'ext:owner' )
          }
          
          vtour.showDetail( detail, vtour.results.activeTab.el.id );
        }
      }); 
      
      // create the script tag proxy for loading the results.  all flickr photo
      // searches will use this same proxy object
      vtour.pxy = new Ext.data.ScriptTagProxy({
        callbackParam: 'jsoncallback',
        url: 'http://api.flickr.com/services/rest/'
      });
      
      vtour.photoReader = new Ext.data.JsonReader(
        {
          successProperty: 'stat',
          totalProperty: 'photos.total',
          root: 'photos.photo',
          id: 'id'
        }, 
        Ext.data.Record.create([
          {name: 'id'},
          {name: 'owner'},
          {name: 'secret'},
          {name: 'server'},
          {name: 'farm'},
          {name: 'title'},
          {name: 'ispublic'},
          {name: 'isfriend'},
          {name: 'isfamily'},
          {name: 'latitude', type: 'float'},
          {name: 'longitude', type: 'float'},
          {name: 'accuracy', type: 'int'},
          {name: 'place_id'},
          {name: 'woeid', type: 'int'},
          {name: 'tags'}
        ])
      );
      
      vtour.searchTpl = new Ext.XTemplate( 
        '<tpl for=".">',
        '<div class="thumb-wrap" id="{title}">',
        '<div class="thumb" ext:position="{longitude},{latitude}" ',
        'ext:tags="{tags}" ext:image="{imageurl}" ext:title="{title}" ',
        'ext:imageid="{id}" ext:owner="{owner}">',
        '<img src="{thumburl}" title="{title}"></div>',
        '<span class="x-editable">{title}</span></div>',
        '</tpl>',
        '<div class="x-clear"></div>'
      );
    });

    vtour.makeDateMenu = function( initDate, theStore, min ) {
      var btn = new Ext.Toolbar.Button({ 
        text: initDate.format('m/d/y'),
        menu: new Ext.menu.DateMenu({
          listeners:{ 
            'beforeshow':function(menu){
              menu.picker.setValue( initDate );
            },
            'select':function(picker,date){
              btn.setText( date.format('m/d/y') );
              if ( min ) {
                theStore.baseParams.min_taken_date = date.format('Y-m-d');
              }
              else {
                theStore.baseParams.max_taken_date = date.format('Y-m-d');
              }
            }
          }
        }),
        menuAlign:'br-tr'
      });

      return btn;
    };

    vtour.makeTextMenu = function( txt, theStore ) {
      var txtBtn = new Ext.Toolbar.Button({
        text: '\''+txt+'\'',
        handler: function(btn){
          var l = new Ext.Layer({});
          var tags = btn.getText().match( /^'(.*)'$/ )[1];
          
          l.update('<div class="tagEdit"><input type="text" value="' + tags + '"/></div>');
          l.show();
          l.alignTo( btn.el, 'bl-tl' );

          var html = Ext.DomQuery.select( 'div.tagEdit input' );
          if (html != null && html.length == 1)
            html[0].focus();

          l.on( 'keypress', function(evt){
            if ( evt.keyCode == 13 ) {
              l.hide();

              var theTxt = '';
              if ( html != null && html.length == 1 )
                 theTxt = html[0].value;
                
              btn.setText( '\'' + theTxt + '\'' );
              theStore.baseParams.tags = theTxt;

              l.remove();
            };
          });
        }
      });

      return txtBtn;
    };
      
    vtour.getFlickrPhotos = function( bbox, boxFeature, constraints ) {
      var toDate = constraints.todate || new Date();
      var fromDate = constraints.fromdate || (function(){ 
        var d = new Date(); 
        d.setFullYear( d.getFullYear() - 1 );
        return d;
      })();
      var tags = constraints.tags || '';
      var ppg = constraints.perpage || 10;

      var store = new Ext.data.Store({
        proxy: vtour.pxy,
        reader: vtour.photoReader,
        baseParams: {
          method: 'flickr.photos.search',
          format: 'json',
          api_key: vtour.flickrkey,
          bbox: bbox,
          min_taken_date: fromDate.format('Y-m-d'),
          max_taken_date: toDate.format('Y-m-d'),
          extras:'geo,tags',
	  tags: tags
        }
      });
      
      store.load({ params:
        {
          page: 1,
          per_page: ppg
        }
      });
      
      var oneSearchPanel = new Ext.Panel({
        cls:'images-view',
        width:535,
        layout:'fit',
        title:'Search '+(vtour.results.items.length),

        items: new Ext.DataView({
          store: store,
          tpl: vtour.searchTpl,
          autoHeight:true,
          multiSelect: true,
          overClass:'x-view-over',
          itemSelector:'div.thumb-wrap',
          emptyText: '',
      
          prepareData: function(data){
            data.thumburl = 'http://farm' + data.farm + '.static.flickr.com/' + data.server + 
              '/' + data.id + '_' + data.secret + '_s.jpg';
            data.imageurl = 'http://farm' + data.farm + '.static.flickr.com/' + data.server + 
              '/' + data.id + '_' + data.secret + '_m.jpg';
            return data;
          }
        }),

        bbar: new Ext.FlickrPagingToolbar({
	  pageSize: ppg,
	  store: store,
	  displayInfo: true,
	  displayMsg: 'Displaying images {0} - {1} of {2}',
	  emptyMsg: 'No images to display',
          items:[
            '-',
            { xtype: 'tbtext', text: 'From:' },
            vtour.makeDateMenu( fromDate, store, true ),
            '-',
            { xtype: 'tbtext', text: 'To:' },
            vtour.makeDateMenu( toDate, store, false ),
            '-',
            { xtype: 'tbtext', text: 'Tags:' },
            vtour.makeTextMenu( tags, store )
          ],
          listeners: {
            'beforedestroy': function(cmp){ 
              // destroy all the items in this toolbar, because something happens
              // with the menus and buttons that keeps the panel from clearing
              // if the items are not cleared when the toolbar is destroyed
              cmp.items.clear();
            }
          }
        }),        
        
        listeners: {
          // this activate function is eye candy
          'activate': function(p) {
            var layer = vtour.ol_layers['features'];
            var index = vtour.results.items.findIndex( 'id', p.id );
            var feature = (layer.features.slice( index-1, index ))[0];
            var tween = new OpenLayers.Tween();
            tween.start( 
              { t: 255 }, 
              { t: 0 }, 
              20, 
              {
                callbacks: {
                  eachStep: function( val ){ 
                    if( feature ){
                      feature.style.fillOpacity = 0.2 + (val['t'] / 255) * 0.8; 
                      layer.redraw();
                    }
                    else {
                      tween.stop();
                    }
                  }
                }
              }
            ); // end tween.start
          },
          'render': function(rendered){
            vtour.results.fireEvent('render',rendered);
          }
        }
      }); // end ext.panel
      
      boxFeature.attributes.searchElem = oneSearchPanel.id;
      boxFeature.attributes.fromdate = fromDate;
      boxFeature.attributes.todate = toDate;
      boxFeature.attributes.tags = tags;

      // show results
      vtour.results.add( oneSearchPanel ).show();      
    }

    vtour.setMapHeight = function(){
      // compute the size of the map div for IE/safari/etc
      var mElem = Ext.get(Ext.get('mapDiv').dom.parentNode.parentNode);
      document.getElementById( 'mapDiv' ).style.height = mElem.getComputedHeight() + 'px';
    }
	</script>
  <style type="text/css">
    html,body,div {
      font-family: "Arial,Helvetica,sans-serif"
    }
    div#mapLayerSwitcherPanel {
      padding:2px;
    }
    div#searchControl {
      padding:2px;
    }
    div#south {
      padding-top: 1.4em;
      text-align: center;
      font-size: 2em;
      color: #999999;
    }
    
    /** paging toolbar and dataview **/
    .images-view .x-panel-body{
    	background: white;
    	font: 11px Arial, Helvetica, sans-serif;
    }
    .images-view .thumb{
    	background: #dddddd;
    	padding: 3px;
    }
    .images-view .thumb img{
    	height: 75px;
    	width: 75px;
    }
    .images-view .thumb-wrap{
    	float: left;
    	margin: 4px;
    	margin-right: 0;
    	padding: 2px;
    	width: 81px;
    	overflow: hidden;
    }
    .images-view .thumb-wrap span{
    	display: block;
    	overflow: hidden;
    	text-align: center;
    	white-space: nowrap;
    }

    .images-view .x-view-over{
	background: #efefef;
	border:1px solid #dddddd;
	padding: 1px;
    }

    .images-view .x-view-selected{
        background: #dedede;
    	border:1px solid #cccccc;
    	padding: 1px;
    }
    .images-view .x-view-selected .thumb{
    	background:transparent;
    }

    .images-view .loading-indicator {
    	font-size:11px;
    	background-image:url('../../resources/images/default/grid/loading.gif');
    	background-repeat: no-repeat;
    	background-position: left;
    	padding-left:20px;
    	margin:10px;
    }
    /* Fix for Firefox 3 */
    .x-date-middle {
      width: 160px;
    }
    .x-grid3 table {
      table-layout:fixed;
    }
  </style>
<!-- end ExtJS scripts -->

<!-- OpenLayers scripts -->
  <script type="text/javascript" src="OpenLayers-2.7/lib/Firebug/firebug.js"></script>
  <script type="text/javascript" src="OpenLayers-2.7/OpenLayers.js"></script>
  <script type="text/javascript" src="OpenLayers-2.6/lib/Proj4js/proj4js.js"></script>
  <script type="text/javascript" src="http://api.maps.yahoo.com/ajaxymap?v=3.7&appid=APP-ID"></script>
  <script type="text/javascript" src="http://maps.google.com/maps?file=api&v=2.82&key=GMAP-KEY"></script>
  <script type="text/javascript">
    function ol_init(){
      Proj4js.libPath = 'OpenLayers-2.6/lib/Proj4js/';
      var options = {
        projection: new OpenLayers.Projection('EPSG:900913'),
        displayProjection: new OpenLayers.Projection('EPSG:4326'),
        units: 'm',
        maxResolution: 156543.0339,
        maxExtent: new OpenLayers.Bounds( -20037508, -20037508, 20037508, 20037508.34 )
      };

      vtour.boxWidth = 20;
      vtour.setMapHeight();

      vtour.geojson = new OpenLayers.Format.GeoJSON({
        externalProjection:options.displayProjection,
        internalProjection:options.projection
      });

      vtour.ol_map = new OpenLayers.Map('mapDiv', options);

      vtour.ol_map.addControl(new OpenLayers.Control.KeyboardDefaults());

      vtour.ol_layers = {
        yahoo: new OpenLayers.Layer.Yahoo( "Yahoo", { sphericalMercator: true } ),
        google: new OpenLayers.Layer.Google( "Google", { sphericalMercator: true } ),
        features: new OpenLayers.Layer.Vector('Bounding Boxes'),
        markers: new OpenLayers.Layer.Vector(
          "Marker Drop Shadows",
          {
            styleMap: new OpenLayers.StyleMap({
              'default': {
                // Set the external graphic and background graphic images.
                externalGraphic: "OpenLayers-2.6/img/marker-gold.png",
                backgroundGraphic: "OpenLayers-2.6/img/marker_shadow.png",

                graphicXOffset: -10,
                graphicYOffset: -21,
                
                // Makes sure the background graphic is placed correctly relative
                // to the external graphic.
                backgroundXOffset: 0,
                backgroundYOffset: -17,
                
                // Set the z-indexes of both graphics to make sure the background
                // graphics stay in the background (shadows on top of markers looks
                // odd; let us not do that).
                graphicZIndex: 101,
                backgroundGraphicZIndex: 100,
                
                pointRadius: 10
              },
              select: {
                externalGraphic: "OpenLayers-2.6/img/marker-green.png",
                pointRadius: 10
              }
            }),
            isBaseLayer: false,
            rendererOptions: {yOrdering: true}
          }
        )
      };

      //
      // select photo items
      //
      selectControl = new OpenLayers.Control.SelectFeature(
        vtour.ol_layers['markers'],
        {
          onSelect: function (feature) {
	    // feature has an attribute 'searchDetail' that contains:
	    // title, position, tags, image
            var detail = feature.attributes.searchDetail;
            var popup = new OpenLayers.Popup.FramedCloud(
              "photo", 
              feature.geometry.getBounds().getCenterLonLat(),
              null,
              '<div style="width:' + (detail.image.width+6) + 'px;" class="detail">' +
		'<h2 class="detail">' + detail.title +  '</h2>' +
                '<div><input type="checkbox" id="' + feature.id + '_delme" name="' + feature.id + '_delme"/> ' + 
                '<label for="' + feature.id + '_delme">hide</label></div>' +
		'<img src="' + detail.image.src + '" alt="' + detail.title +
		'" title="' + detail.title + '" width="' + detail.image.width +
		'" height="' + detail.height + '" class="detail"/>' +
		'<div class="detaillink"><a href="http://www.flickr.com/photos/' + detail.owner + '/' + 
		detail.imageid + '" target="_blank" class="detail">photopage</a></div>' +
		'<p class="detail"><span class="detail">tags</span>:' + detail.tags + '</p>' +
		'</div>',
              null, 
              true, 
              function (evt) {
                var chk = Ext.get(feature.id+'_delme'); 
                var remove = chk.dom.checked;
                OpenLayers.Event.stop(evt);
                selectControl.unselect(feature);

                if (remove) { 
                  vtour.ol_layers['markers'].removeFeatures( [feature] );
                }
              }
            );
              
            feature.popup = popup;
            vtour.ol_map.addPopup(popup);
          }, 
          onUnselect: function (feature) {
            vtour.ol_map.removePopup(feature.popup);
            feature.popup.destroy();
            feature.popup = null;
          }
        }
      );
      
      vtour.ol_map.addControl(selectControl);
      selectControl.activate();
      //
      // end of select photo items
      //

      for ( var key in vtour.ol_layers )
      {
        vtour.ol_map.addLayer( vtour.ol_layers[key] );
      }

      vtour.ol_map.setCenter(new OpenLayers.LonLat(-8367155.413500762,4859078.000840925), 12);

      vtour.ol_map.events.register('click', vtour.ol_map, focusRegion );
    }

    function ol_resize() {
      vtour.ol_map.updateSize();
    }

    function changeLayer( element ) {
      vtour.ol_map.setBaseLayer( vtour.ol_layers[ element.value ] );
    }

    function changeRadius( element ) {
      vtour.boxWidth = element.value * 2;
    }

    function focusRegion(e) {
      var lonlat = vtour.ol_map.getLonLatFromPixel(e.xy);
      var bounds = vtour.ol_map.getExtent();

      var sz = Math.min( bounds.getWidth(), bounds.getHeight() ) / vtour.boxWidth;

      var myBounds = new OpenLayers.Bounds( lonlat.lon-sz, lonlat.lat-sz,
	lonlat.lon+sz, lonlat.lat+sz );
      
      var rectangle = myBounds.toGeometry();
      var polygonFeature = new OpenLayers.Feature.Vector(
        rectangle, { searchElem: '' }, {
          fillColor: '#fff',
          fillOpacity: 0.2,
          strokeColor: '#333',
          strokeOpacity: 0.5,
          strokeWidth: 1,
          strokeLinecap: 'round'
        });

      vtour.ol_layers['features'].addFeatures([polygonFeature]);

      var prjBounds = vtour.projectBounds( myBounds, true );

      // get settings from the UI
      var datefrm = vtour.datePanel.getForm();
      var tagfrm = vtour.tagPanel.getForm();

      var constraints = {
        perpage: Math.floor(vtour.results.activeTab.el.getWidth()/93),
        fromdate: datefrm.findField('fromDate').getValue(),
        todate: datefrm.findField('toDate').getValue(),
        tags: tagfrm.findField('tagFilter').getValue()
      };
      
      vtour.getFlickrPhotos( prjBounds.toBBOX(), polygonFeature, constraints );
    };

    vtour.projectBounds = function( bounds, fwd ) {
      var pts = bounds.toArray();
      var fromProj = (fwd) ? vtour.ol_map.projection.proj : vtour.ol_map.displayProjection.proj;
      var toProj = (fwd) ? vtour.ol_map.displayProjection.proj : vtour.ol_map.projection.proj;
      
      var ptMin = Proj4js.transform( 
        fromProj, 
        toProj,
        { x: pts[0], y: pts[1] } );
      var ptMax = Proj4js.transform(
        fromProj,
        toProj,
        { x: pts[2], y: pts[3] } );

      return new OpenLayers.Bounds( ptMin.x, ptMin.y, ptMax.x, ptMax.y );
    };
    
    vtour.showDetail = function( detail, comp ) {
      // put something on the map
      
      // reproject from 4326
      var pt = Proj4js.transform( 
        vtour.ol_map.displayProjection.proj, 
        vtour.ol_map.projection.proj, 
        { x: detail.position.lon, y: detail.position.lat } );
      
      // create a feature array of 1 item
      var feature = new OpenLayers.Feature.Vector(
        new OpenLayers.Geometry.Point(pt.x, pt.y),
        {
          searchElem: comp,
          searchDetail: detail
        }
      );

      // attach to the feature layer
      vtour.ol_layers['markers'].addFeatures( [feature] );
    }

    vtour.saveTour = function( id, name, date, success, failure ) {
      // create a bounding box, that would be the bounds of all searches
      var allBounds = new OpenLayers.Bounds();
      var feature = null;
      for( var i = 0; i < vtour.ol_layers['features'].features.length; i++ ) {
        feature = vtour.ol_layers['features'].features[i];
        allBounds.extend(feature.geometry.getBounds());
      }

      feature = new OpenLayers.Feature.Vector( allBounds.toGeometry(),
	{
	  user_id: id,
	  name: name,
	  date: date.format('Y-m-d'),
	  public: false
	}
      ); 

      new OpenLayers.Ajax.Request(vtour.fsurl + '/tour?format=geojson', {
	method: 'post', 
	postBody: vtour.geojson.write(feature),
	requestHeaders: ['Accept', 'application/json'],
	asynchronous: false,
	onSuccess: success,
	onFailure: failure
      });
    };

    vtour.saveSearch = function( userId, tourId, feature, success, failure ) {
      var feat = new OpenLayers.Feature.Vector( feature.geometry, {
        'user_id': userId,
        tour: tourId,
        fromdate: feature.attributes['fromdate'],
        todate: feature.attributes['todate'],
        tags: feature.attributes['tags']
      } );

      new OpenLayers.Ajax.Request(vtour.fsurl + '/search?format=geojson', {
        method: 'post',
        postBody: vtour.geojson.write(feat),
        requestHeaders: ['Accept', 'application/json'],
        asynchronous: false,
        onSuccess: success,
        onFailure: failure
      });
    };

    vtour.saveResult = function( userId, searchId, details, geometry, success, failure ) {
      // create a point
      var center = geometry.getBounds().getCenterLonLat();
      var feat = new OpenLayers.Feature.Vector(
        new OpenLayers.Geometry.Point( center.lon, center.lat ),
        {
          user_id: userId,
          search: searchId,
          thumb_url: details.image.src,
          name: details.title,
          page_url: 'http://www.flickr.com/photos/' + details.owner + '/' + details.imageid
        }
      );

      new OpenLayers.Ajax.Request(vtour.fsurl + '/result', {
        method: 'post',
        postBody: vtour.geojson.write(feat),
        requestHeaders: ['Accept', 'application/json'],
        asynchronous: false,
        onSuccess: success,
        onFailure: failure
      });
    };
  </script>
  <style type="text/css">
    div#mapDiv {
      height:100%;
      width:100%;
    }
    div.detail {
      padding: 5px;
    }
    h2.detail {
    }
    p.detail {
      color:#666666;
      font-size:0.75em;
      padding:2px;
    }
    img.detail {
    }
    span.detail {
      font-weight:bold;
    }
    div.detaillink {
      text-align:right;
    }
    a.detail {
      font-size:0.7em;
    }
    div.detail label {
      font-size:0.7em;
      vertical-align:top;
    }
    div.detail div {
      text-align:right;
    }
  </style>
<!-- end OpenLayers scripts -->
</head>
<body onload="ol_init();">
  <div id="center">
    <div id="mapDiv">
    </div>
  </div>
  <div id="mapLayerSwitcherPanel" class="x-hidden">
    <ul>
      <li><input type="radio" name="olLayerName" value="yahoo" onclick="changeLayer(this);" checked="checked"/>Yahoo</li>
      <li><input type="radio" name="olLayerName" value="google" onclick="changeLayer(this);"/>Google</li>
    </ul>
  </div>
  <div id="searchPanel" class="x-hidden" style="padding:2px;">
    <ul>
      <li>
        <input type="radio" name="searchRadius" value="20" onclick="changeRadius(this);" id="sr1" />
        <label for="sr1">Small</label>
      </li>
      <li>
        <input type="radio" name="searchRadius" value="10" checked="checked" onclick="changeRadius(this);" id="sr2"/>
        <label for="sr2">Medium</label>
      </li>
      <li>
        <input type="radio" name="searchRadius" value="5" onclick="changeRadius(this);" id="sr3" /> 
        <label for="sr3">Large</label>
      </li>
    </ul>
  </div>
  <div id="datePanel" class="x-hidden">hi!</div>
  <div id="south">
    <p>Click on the map to search for photos.</p>
  </div>
 </body>
</html>
