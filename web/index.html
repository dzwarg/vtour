<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ext="http://www.extjs.com/">
<head>
  <title>vTour</title>

  <!-- ExtJS scripts -->
  <link rel="stylesheet" type="text/css" href="ext-2.0.2/resources/css/ext-all.css" />
  <link rel="stylesheet" type="text/css" href="ext-2.0.2/resources/css/xtheme-gray.css" />
  <script type="text/javascript" src="ext-2.0.2/adapter/ext/ext-base.js"></script>
  <script type="text/javascript" src="ext-2.0.2/ext-all-debug.js"></script>
  <script type="text/javascript" src="FlickrAdapter.js"></script>
  <script type="text/javascript" src="PanoramioAdapter.js"></script>
  <script type="text/javascript" src="PicasaAdapter.js"></script>
  <script type="text/javascript" src="json2.js"></script>
  <script type="text/javascript">
    Ext.BLANK_IMAGE_URL = 's.gif';
    vtour.fsurl = 'http://www.spondubone.net/fs/featureserver.cgi';
    vtour.adapters = {
      flickr: new vtour.FlickrAdapter(),
      panoramio: new vtour.PanoramioAdapter(),
      picasa: new vtour.PicasaAdapter()
    };

    Ext.onReady(function(){

      var state = new Ext.state.CookieProvider();
      //Ext.state.Manager.setProvider( state );
      
      var welcomeTemplate = new Ext.Template( 'Welcome, {0}' );
      var TourRecord = Ext.data.Record.create([ 'name', 'id', 'bbox', { name: 'date', type: 'date' } ]);
      TourRecord.prototype.toString = function() {
        return this.get('id') + ':' + 
          this.get('name') + ':' + 
          this.get('bbox') + ':' + 
          this.get('date').valueOf();
      };
      TourRecord.fromString = function(str) {
        var tInfo = str.split(/:/);
        return new TourRecord({
          id: tInfo[0],
          name: tInfo[1], 
          bbox: tInfo[2], 
          date: new Date(parseInt(tInfo[3],10))
        });
      };
      var myTourStore = new Ext.data.SimpleStore({
        fields: [ 'name', 'id', 'bbox', 'date' ],
        data: []
      });

      var fixDate = function(d) {
        if ( d==null ) return null;
        var m=d.match(/(\d+)-(\d+)-(\d+)/);
        m=Date.parse(m[2] + '/' + m[3] + '/' + m[1]);
        return new Date(m);
      };
      
      var addSearchToDisplay = function(searches, detailFinish) {
        var index = 0;
        var addSearchToDisplay2 = function(comp){
          if ( index < searches.length ) {
            if ( comp ) {
              var dom = comp.getEl().dom;
              var imgs = Ext.DomQuery.select( 'img', dom );
              var paging = Ext.DomQuery.select( 'div.x-paging-info', dom );

              if ( paging.length == 0 ) {
                setTimeout( function(){ addSearchToDisplay2(comp); }, 100 );
                return;
              }

              if( imgs.length == 0 && !paging[0].innerHTML.match( /No images.*/ ) ) {
                setTimeout( function(){ addSearchToDisplay2(comp); }, 100 );
                return;
              }
            }

            var prjBounds = new OpenLayers.Bounds();
            prjBounds.extend( searches[index].geometry.getBounds() );
            prjBounds.transform(
              vtour.ol_map.projection, vtour.ol_map.displayProjection
            );
            var constraints = {
              perPage: Math.floor(vtour.results.activeTab.el.getWidth()/93),
              fromdate: fixDate(searches[index].attributes[ 'fromdate' ]),
              todate: fixDate(searches[index].attributes[ 'todate' ]),
              tags: searches[index].attributes[ 'tags' ],
              service: searches[index].attributes[ 'service' ]
            };
            
            index++;
            var adapter = vtour.adapters[vtour.searchService];
            vtour.getPhotos( adapter, prjBounds.toBBOX(), searches[index-1], constraints );
          }
          else {
            vtour.results.un('render',addSearchToDisplay2,window);
            
            detailFinish(searches);
          }
        };

        return addSearchToDisplay2;
      };

      var addResultToDisplay = function(searches){
        var addResultToDisplay2 = function(idx){
          if ( idx >= searches.length )
            return;

          OpenLayers.Request.issue({
            url: vtour.fsurl + '/result',
            params: { 
              queryable: 'search', 
              search: searches[idx].fid, 
              format: 'geojson' 
            },
            method: 'GET',
            headers: {'Accept':'application/json'},
            async: true,
            success: function(xhr) {
              var results = vtour.geojson.read( xhr.responseText, 'FeatureCollection' );

              for ( var i = 0; i < results.length; i++ ) {
                var detail = {
                  tags: searches[idx].attributes.tags,
                  position: { lon: results[i].geometry.x, lat: results[i].geometry.y },
                  image: (function(img){
                    var i = new Image();
                    i.src = img;
                    return i;
                  })(results[i].attributes['thumb_url']),
                  title: results[i].attributes['name'],
                  page_url: results[i].attributes['page_url']
                };

                var comp = vtour.results.getComponent(idx+1);

                results[i].attributes.searchDetail = detail;
                results[i].attributes.searchElem = comp.el.id;
                vtour.showDetail( results[i] );
              }

              setTimeout( function(){ addResultToDisplay2(idx+1); }, 100 );
            }
          });
        };
        addResultToDisplay2(0);
      }

      var searchCombo = new Ext.form.ComboBox({
        store: new Ext.data.Store({
          proxy: new Ext.data.ScriptTagProxy({
            url: 'http://ws.geonames.org/searchJSON',
            callbackParam: 'callback'
          }),
          reader: new Ext.data.JsonReader({
            root: 'geonames',
            totalProperty: 'totalResultsCount',
            id: 'geonameId'
          }, [
            {name: 'name'},
            {name: 'adminCode1'},
            {name: 'adminName1'},
            {name: 'countryCode' },
            {name: 'countryName' },
            {name: 'lng', type: 'float'},
            {name: 'lat', type: 'float'}
          ]),
          baseParams:{
            maxRows: 10,
            lang: 'en',
            style: 'medium',
            featureClass:'P'
          }
        }),
        displayField:'name',
        loadingText: 'Searching...',
        queryParam: 'name',
        itemSelector: 'div.x-combo-list-item',
        tpl:new Ext.XTemplate( 
          '<tpl for=".">',
          '<tpl if="this.isShort(countryCode)">',
          '<div class="x-combo-list-item">{name}, {adminName1}</div>',
          '</tpl>',
          '<tpl if="!this.isShort(countryCode) && this.isMedium(adminName1)">',
          '<div class="x-combo-list-item">{name}, {countryName}</div>',
          '</tpl>',
          '<tpl if="!this.isShort(countryCode) && !this.isMedium(adminName1)">',
          '<div class="x-combo-list-item">{name}, {adminName1}, {countryName}</div>',
          '</tpl>',
          '</tpl>',
          {
            isShort: function( code ) { return code=='US'; },
            isMedium: function( name ) { return name==null||name.length==0; }
          }
        ),
        mode:'remote',
        width: 165,
        listeners: {
          select: function(combo,record,index){
            var pos = new OpenLayers.LonLat( record.get('lng'), record.get('lat') );
            pos.transform( vtour.ol_map.displayProjection, vtour.ol_map.projection );

            vtour.ol_map.panTo( pos );
          }
        }
      });

      var placeSearchPanel = new Ext.Panel({
        title:'Find a Place',
        collapsed: false,
        bodyStyle: 'padding:2px;',
        items: [
          searchCombo
        ]
      });

      var tourCombo = new Ext.form.ComboBox({
        store: myTourStore,
        displayField: 'name',
        mode: 'local',
        triggerAction: 'all',
        emptyText: 'Select Tour...',
        width: 145,
        fieldLabel: 'Tour',
        labelStyle: 'padding-left:2px;width:43px;',
        valueNotFoundText: 'Loading...',
        editable: false,
        sortInfo: { field: 'name', direction: 'ASC' },
        listeners: {
          select: function(combo,record,index) {
            // this loop clears all geometries from tours -- but not tour settings.
            while (vtour.results.getComponent(1) != null) {
              vtour.results.remove( vtour.results.getComponent(1) );
            }

            // zoom to the tours extent
            vtour.ol_map.zoomToExtent( OpenLayers.Bounds.fromString( record.get('bbox') ) );

            // update the name of the tour in the mgmt panel
            var fld = tourMgmtPanel.getForm().findField('tourName');
            var vDator = fld.validator;
            fld.validator = function(v){ return true; };
            fld.setValue( record.get('name') );
            fld.validator = vDator;

            // update the creation date in the mgmt panel
            Ext.get('tourMgmtCreateTime').update('Created on: '+record.get('date').format('m/d/y'));

            OpenLayers.Request.issue({
              url: vtour.fsurl + '/search',
              params: { 
                queryable: 'tour',
                tour: record.get('id'), 
                format: 'geojson'
              },
              method: 'GET', 
              headers: {'Accept': 'application/json'},
              async: true,
              success: function( xhr ){
                var searches = vtour.geojson.read( xhr.responseText, 'FeatureCollection' );

                for( var i = 0; i < searches.length; i++ ) {
                  searches[i].attributes.searchElem = '';
                  searches[i].style = {
                    fillColor: '#fff',
                    fillOpacity: 0.2,
                    strokeColor: '#333',
                    strokeOpacity: 0.5,
                    strokeWidth: 1,
                    strokeLinecap: 'round'
                  }
                }

                var addSearch = addSearchToDisplay(searches, addResultToDisplay);

                vtour.results.on('render',addSearch,window);

                // add this search feature to the map
                vtour.ol_layers['features'].addFeatures(searches);

                addSearch( null );
              }
            });
          }
        }
      });

      var loggedInPanel = new Ext.FormPanel({
        title:'My Account',
        collapsed: false,
        labelWidth: 43,
        items: [
          new Ext.Panel({
            id: 'welcomePanel',
            border:false,
            html: '',
            style: 'margin:0px 0px 5px 0px; padding: 2px;'
          }),
          tourCombo
        ]
      });
      
      var loginPanel = new Ext.FormPanel({
        title:'Sign In',
        collapsed: false,
        defaultType: 'textfield',
        labelWidth: 63,
        labelAlign: 'right',
        items: [
          new Ext.Panel({
            border: false,
            html: 'Sign in, or register to start saving your tours.',
            style: 'margin:0px 0px 5px 0px; padding: 2px;'
          }),
          {
            fieldLabel: 'Login',
            name: 'user',
            width: 125,
            vtype: 'alphanum',
            allowBlank: false
          }, {
            inputType:'password',
            fieldLabel: 'Password',
            name: 'password',
            width: 125,
            allowBlank: false
          }
        ],
        method: 'GET',
        url: '/~davidz/users/login'
      });

      loginPanel.addButton({
        text: 'Sign In',
        handler: function() {
          var frm = loginPanel.getForm();
          if ( frm.isValid() ) {
            frm.submit({
              waitMsg:'Logging in...',
              failure: function( form, action ) {
                if ( action.result.message != 'ok' ) {
                  Ext.MessageBox.alert( 'Oops!', action.result.message );
                  return;
                }
                
                loginPanel.hide();
                loginPanel.getForm().reset();
                loggedInPanel.show();
                
                // save auth cookie
                state.set( 'vtour_secret', action.result.secret );
                state.set( 'vtour_user', action.result.user.login );
                state.set( 'vtour_userid', action.result.user.id );
                
                Ext.get('welcomePanel').update( welcomeTemplate.apply( [action.result.user.login] ) );

                tourCombo.setValue( 'Loading...' );

                // show the tour mgmt panel if a tour exists.
                firstPanelSwitch( vtour.results.items.get(0), vtour.results.items.getCount()>1 );

                // get all tours owned by this user
                OpenLayers.Request.issue({
                  url: vtour.fsurl + '/tour',
                  params: { 
                    queryable: 'user_id', 
                    user_id: action.result.user.id, 
                    format: 'geojson' 
                  },
                  method: 'GET', 
                  headers: {'Accept': 'application/json'},
                  async: true,
                  success: function( xhr ){
                    var tours = vtour.geojson.read( xhr.responseText, 'FeatureCollection' );

                    var tourRecs = [];
                    var tourState = [];
                    for ( var i = 0; i < tours.length; i++ ) {
                      var tRec = new TourRecord({
                        name: tours[i].attributes.name,
                        date: Date.parseDate(tours[i].attributes.date, "Y-m-d"),
                        id: tours[i].fid,
                        bbox: tours[i].geometry.getBounds().toBBOX()
                      });

                      tourRecs.push( tRec );
                      tourState.push( tRec.toString() );
                    }

                    myTourStore.add( tourRecs );
                    state.set( 'vtour_tours', tourState.join(';') );

                    tourCombo.reset();
                  }
                });
              }
            });
          }
        }
      });
      
      var registerWin;

      loginPanel.addButton({
        text: 'Register',
        handler: function() {
          if ( !registerWin ) {
            var registerForm = new Ext.FormPanel({
              border: false,
              collapsible: false,
              bodyStyle:'padding:2px 2px 2px 2px;',
              method:'POST',
              url:'/~davidz/users/register',
              items: [
                new Ext.form.FieldSet({
                  title: 'Pick a login',
                  labelAlign: 'right',
                  labelWidth: 63,
                  height: 53,
                  defaultType: 'textfield',
                  items: [{
                    fieldLabel: 'Login', 
                    name: 'user', 
                    width: 125,
                    vtype: 'alphanum',
                    allowBlank: false                    
                  }]
                }),
                new Ext.form.FieldSet({
                  title: 'Pick a good password',
                  labelAlign: 'right',
                  labelWidth: 63,
                  height: 80,
                  defaultType: 'textfield',
                  items:[{ 
                    fieldLabel: 'Password', 
                    name: 'password', 
                    width: 125,
                    inputType: 'password',
                    allowBlank: false
                  },{ 
                    fieldLabel: 'Verify', 
                    name: 'password2', 
                    width: 125,
                    inputType: 'password',
                    allowBlank: false
                  }]
                }),
                new Ext.form.FieldSet({
                  title: 'Finally, your email address',
                  labelAlign: 'right',
                  labelWidth: 63,
                  height: 80,
                  defaultType: 'textfield',
                  items: [{
                    fieldLabel: 'Email', 
                    name: 'email', 
                    width: 125,
                    vtype: 'email',
                    allowBlank: false
                  },{ 
                    fieldLabel: 'Verify', 
                    name: 'email2', 
                    width: 125,
                    vtype: 'email',
                    allowBlank: false
                  }]
                })
              ]
            });
            
            registerWin = new Ext.Window({
              title: 'Register an account',
              modal: true,
              closeAction: 'hide',
              items:[
                registerForm
              ],
              buttons: [
                new Ext.Button({ 
                  text: 'Register',
                  handler: function() {
                    var frm = registerForm.getForm();
                    if ( frm.findField('password').el.getValue() != frm.findField('password2').el.getValue() ) {
                      frm.markInvalid([{
                        id: 'password',
                        msg: 'Passwords must match.'
                      },{
                        id: 'password2',
                        msg: 'Passwords must match.'
                      }]);
                      return;
                    }
                    if (frm.findField('email').el.getValue() != frm.findField('email2').el.getValue() ) {
                      frm.markInvalid([{
                        id: 'email',
                        msg: 'Email addresses must match.'
                      },{
                        id: 'email2',
                        msg: 'Email addresses must match.'
                      }]);
                      return;                      
                    }
                    if ( frm.isValid() ) {
                      frm.submit({
                        waitMsg:'Registering...',
                        failure: function( form, action ) {
                          if ( action.result.message != 'ok' ) {
                            if ( action.result.message == 'A user with that name already exists.' ) {
                              registerForm.getForm().markInvalid( [{
                                id:'user',
                                msg: action.result.message
                              }] );
                            }
                            else
                              Ext.MessageBox.alert( 'Oops!', action.result.message );
                          }
                          else {
                            registerForm.getForm().reset();
                            registerWin.hide();
                          }
                        }
                      });
                    }
                  }
                }),
                new Ext.Button({
                  text: 'Cancel',
                  handler: function() {
                    registerForm.getForm().reset();
                    registerWin.hide();
                  }
                })
              ]
            });
          }

          registerWin.show();
        }
      });

      loggedInPanel.addButton({
        text: 'Sign Out',
        handler: function() {
          // clear cookies
          state.clear( 'vtour_secret' );
          state.clear( 'vtour_user' );
          state.clear( 'vtour_userid' );
          state.clear( 'vtour_tours' );

          myTourStore.removeAll();
                        
          loggedInPanel.hide();
          loginPanel.show();

          // clear any tours that are in the lightbox
          firstPanelSwitch( vtour.results.items.get(0), false );
        }
      });

      vtour.datePanel = new Ext.form.FormPanel({
        formId: 'dateRangeFrm',
        collapsed: true,
        title: 'Date Range',
        labelWidth: 63,
        labelAlign: 'right',
        defaultType: 'datefield',
        bodyStyle: 'margin:0px;padding:2px;',
        items: [{
          name: 'fromDate',
          allowBlank: false,
          width: 60,
          fieldLabel: 'From',
          value: (function(){
            var d=new Date();
            d = new Date(d.valueOf() + 24*60*60*1000);
            d.setFullYear( d.getFullYear()-1 );
            return d;
          })(),
          maxValue: new Date(),
          minValue: (function(){
            var d = new Date();
            d.setFullYear( d.getFullYear()-1 );
            return d;
          })()
        },{
          name: 'toDate',
          allowBlank: false,
          width: 60,
          fieldLabel: 'To',
          value: new Date(),
          maxValue: new Date(),
          minValue: (function(){
            var d = new Date();
            d.setFullYear( d.getFullYear()-1 );
            return d;
          })()
        }]
      });

      vtour.tagPanel = new Ext.form.FormPanel({
	formId: 'tagForm',
	collapsed: true,
	title: 'Tag Filter',
	labelWidth: 63,
	labelAlign: 'right',
	defaultType: 'textfield',
	bodyStyle: 'margin:0px;padding:2px;',
	items:[{
	  name: 'tagFilter',
	  allowBlank: true,
	  width: 125,
	  fieldLabel: 'Tags'
	}]
      });

      var markup = [];

      for ( var sk in vtour.adapters ) {
        markup.push( vtour.adapters[sk].getSelector( markup.length == 0 ) );
      }

      markup = Ext.DomHelper.markup({ tag: 'ul', children: markup });

      var svcPanel = new Ext.Panel({
        title:'Search Service',
        id:'servicePanel',
        html: markup,
        collapsed: true,
        bodyStyle: 'margin:0px;padding:2px;'
      });
      
      var eastPanel = new Ext.Panel({
        region:'east',
        id:'eastPanel',
        width:200,
        defaults: {
          // applied to each contained panel
          collapsible:true,
          border:false
        },
        items:[
          { title:'Map Layers',
            contentEl:'mapLayerSwitcherPanel',
            collapsed: false,
            bodyStyle: 'margin:0px;' },
          svcPanel,
          placeSearchPanel,
          loginPanel,
          loggedInPanel,
          { title:'Search Distance',
            contentEl:'searchPanel',
            collapsed: true,
            bodyStyle: 'margin:0px;' },
          vtour.datePanel,
	  vtour.tagPanel
        ]
      });

      var firstPanelSwitch = function(panel,instr){
        var loggedin = state.get( 'vtour_user', '' ) !== '';
	if ( loggedin && instr ) {
	  panel.setTitle( 'Tour Options' );
	  panel.items.get(0).hide();
	  panel.items.get(1).show();
	}
	else {
	  panel.setTitle( 'Instructions' );
	  panel.items.get(0).show();
	  panel.items.get(1).hide();
	}
      };

      var saveResultHandler = function( userId, attributes ) {
        return function( resp ) {
          var search = vtour.geojson.read( resp.responseText, 'FeatureCollection' );

          // loop through all markers, and process only the ones in the search
          var markers = vtour.ol_layers['markers'].features;
          for ( var i = 0; i < markers.length; i++ ) {
            if ( markers[i].attributes.searchElem == attributes.searchElem )
              // todo: add thumb_url, image_url, name
              vtour.saveResult( userId, 
                search[0].fid,
                markers[i].attributes.searchDetail,
                markers[i].geometry, 
                function(r){}, 
                function(r){
                  Ext.MessageBox.alert( 'Oops', 'Could not save result' );
                }
              );
          }
        };
      };

      var saveSearchHandler = function( userId ) {
        return function( resp ) {
          var tour = vtour.geojson.read( resp.responseText, 'FeatureCollection' );

          var boxes = vtour.ol_layers['features'].features;
          for ( var i = 0; i < boxes.length; i++ ) {
            vtour.saveSearch( userId, tour[0].fid,
              boxes[i],
              saveResultHandler( userId, boxes[i].attributes ),
              function( resp ) {
                Ext.MessageBox.alert( 'Oops', 'Could not save searches' );
              }
            )
          }

          // indicate that the tour has been saved
          // hide the waiting indicator
          vtour.wait.hide();

          var tRec = new TourRecord({ 
            name: tour[0].attributes.name,
            date: Date.parseDate(tour[0].attributes.date, "Y-m-d"),
            id: tour[0].fid,
            bbox: tour[0].geometry.getBounds().toBBOX()
          });
          myTourStore.add( [tRec] );

          var tourSet = state.get( 'vtour_tours', '' );
          tourSet += tRec.get('id') + ':' + tRec.get('name') + ':' + tRec.get('date').valueOf();
          state.set( 'vtour_tours', tourSet );

          // update the saved time in the mgmt panel
          var created = Ext.get('tourMgmtCreateTime');
          created.update( 'Created on: ' + tRec.get('date').format('m/d/y') );
        };
      };

      var saveTourHandler = function(frm){
        return function( btn, evt ) {
          if ( !frm.isValid() ) return;

          var tourName = frm.findField('tourName').getValue();
          if ( tourName === '' ) {
            frm.findField('tourName').markInvalid();
            return;
          }

          vtour.wait = Ext.MessageBox.wait( 'Saving Tour...' );

          var id = state.get( 'vtour_userid', 0 );
          vtour.saveTour( id, tourName, new Date(),
            saveSearchHandler( id ),
            function( resp ){
              Ext.MessageBox.alert( 'Oops',
                'Error saving tour, please try again later.' );
            }
          );
        };
      };

      var clrTourHandler = function(frm){
        return function( btn, evt ) {
          // this loop clears all geometries from tours -- but not tour settings.
          while (vtour.results.getComponent(1) != null) {
            vtour.results.remove( vtour.results.getComponent(1) );
          }

          // update the name of the tour in the mgmt panel
          var fld = frm.findField('tourName');
          var vDator = fld.validator;
          fld.validator = function(v){ return true; };
          fld.setValue( 'Untitled 1' );
          fld.validator = vDator;

          // update the creation date in the mgmt panel
          Ext.get('tourMgmtCreateTime').update('Unsaved');

          // reset the tour combo, just in case
          tourCombo.reset();
        };
      };

      var delTourHandler = function(frm) {
        return function( btn, evt ){
          var tourField = frm.findField('tourName');
          var created = Ext.get('tourMgmtCreateTime');
          if ( created && (/unsaved/i).test( created.dom.innerHTML ) ) {
            // remove all searches
            while (vtour.results.getComponent(1) != null) {
              vtour.results.remove( vtour.results.getComponent(1) );
            }

            tourField.setValue('Untitled 1');
            created.update('Unsaved');
          }
          else {
            var tourName = tourCombo.getValue();
            var tInd = myTourStore.find('name',tourName);
            if (tInd >= 0) {
              var tRec = myTourStore.getAt(tInd);
              vtour.deleteTour( tRec.get('id'), 
              function(tourId) {
                tInd = myTourStore.find('id',tourId);
                myTourStore.remove( myTourStore.getAt(tInd) );
                var tourState = [];
                for( var i=0; i < myTourStore.getCount(); i++ ) {
                  tRec = myTourStore.getAt(i);
                  tourState.push( tRec.toString() );
                }
                state.set( 'vtour_tours', tourState.join(';') );

                // remove all searches
                while (vtour.results.getComponent(1) != null) {
                  vtour.results.remove( vtour.results.getComponent(1) );
                }

                tourField.setValue('Untitled 1');
                created.update('Unsaved');

                tourCombo.clearValue();
              },
              function(){ 
                Ext.MessageBox( 'Oops', 'Error deleting tour, please try again later.'); 
              });
            }
          }
        };
      };

      var tourMgmtPanel = new Ext.form.FormPanel({
	// provide tour management
	border: false,
        layout: 'column',
        defaults: {
          border: false
        },
	items:[
          new Ext.Panel({
            columnWidth: 0.5,
            bodyStyle: 'padding:10px',
            items:[
              new Ext.form.TextField({
                maxLength: 1024,
                name: 'tourName',
                selectOnFocus: true,
                style: 'font-size:2em;height:1.3em;margin-bottom:10px;',
                value: 'Untitled 1',
                invalidText: 'Enter a name for the tour. Each tour must have a unique name.',
                validator: function( newVal ) {
                  if ( newVal === '' ) return false;

                  var valid = false;
                  if ( vtour && vtour.fsurl && vtour.geojson ) {
                    OpenLayers.Request.issue({
                      url: vtour.fsurl + '/tour',
                      params: { 
                        queryable: 'name,user_id', 
                        name: newVal, 
                        user_id: state.get('vtour_userid'),
                        format: 'geojson' 
                      },
                      method: 'GET', 
                      headers: {'Accept': 'application/json'},
                      async: false,
                      success: function( xhr ){ 
                        var resp = vtour.geojson.read( xhr.responseText, 'FeatureCollection' );
                        valid = (resp.length === 0); 
                      }
                    });
                  }
                  else {
                    // the field is validated once at the beginning, before
                    // the vtour.* objects exist
                    valid = true;
                  }

                  return valid;
                }
              }),
              new Ext.Panel({
                border: false,
                layout: 'column',
                defaults: { 
                  border: false,
                  bodyBorder: true,
                  ctCls: 'opContainer',
                  cls: 'opPanel'
                },
                items: [
                  {
                    contentEl: 'saveBtnPanel'
                  }, {
                    contentEl: 'clrBtnPanel'
                  }, {
                    contentEl: 'delBtnPanel'
                  }
                ],
                listeners: {
                  'afterlayout':function(cont,lyt){
                    var btnAs = Ext.DomQuery.select( 'div.opPanel', cont.el.dom );
                    for( var i = 0; i < btnAs.length; i++ ) {
                      var el = Ext.get(btnAs[i]);
                      el.on( 'mouseover', function(e){ 
                        var el2 = Ext.get(e.getTarget( 'div.opPanel' ));
                        var cmp = Ext.getCmp(el2.id);
                        cmp.body.addClass('opOver');
                      });
                      el.on( 'mouseout', function(e){
                        var el2 = Ext.get(e.getTarget( 'div.opPanel' ));
                        var cmp = Ext.getCmp(el2.id);
                        cmp.body.removeClass('opOver');
                      });
                    }

                    var save = Ext.get('saveBtnPanel');
                    save.on('click', saveTourHandler( tourMgmtPanel.getForm() ) );

                    var clr = Ext.get('clrBtnPanel');
                    clr.on('click', clrTourHandler( tourMgmtPanel.getForm() ) );

                    var del = Ext.get('delBtnPanel');
                    del.on('click', delTourHandler( tourMgmtPanel.getForm() ) );
                  }
                }
              })
            ]
          }),
          new Ext.Panel({
            columnWidth: 0.5,
            bodyStyle: 'padding:10px;',
            defaults: {
              border: false,
              style: 'font-size:1.5em;height:1.1em;margin-bottom:10px;'
            },
            items:[
              { 
                id: 'tourMgmtSearchNum',
                html: '0 searches'
              },{
                id: 'tourMgmtResultNum',
                html: '0 results' 
              },{
                id: 'tourMgmtCreateTime',
                html: 'Unsaved' 
              }
            ]
          })
	]
      });

      vtour.results = new Ext.TabPanel({
        id:'resultTabs',
        visible: false,
        height: 170,
        border: false,
        activeTab: 0,
        enableTabScroll: true,
        defaults: { 
          autoScroll: true, 
          closable: true
        },
        items: [{ 
          title: 'Instructions', 
          closable: false,
	  items: [{
	    border: false,
	    contentEl: 'south'
	  }, tourMgmtPanel ]
        }],
        listeners: {
          'beforeremove': function( me, child ){
            var i = me.items.findIndex( 'id', child.id );
	    vtour.ol_layers['features'].removeFeatures(
	      vtour.ol_layers['features'].features.slice( i-1, i )
	    );
              
	    for ( var j = vtour.ol_layers['markers'].features.length - 1; j >= 0; j-- ) {
	      var feature = vtour.ol_layers['markers'].features[j];
	      if ( feature.attributes.searchElem == child.id ) {
		vtour.ol_layers['markers'].removeFeatures( [feature] );
	      }
	    }

            // update the tour stats, if avail
            var resNum = Ext.get('tourMgmtResultNum');
            if ( resNum ) {
              var num = vtour.ol_layers['markers'].features.length;

              resNum.update( num + ' result' + (num!=1?'s':'') );
            }

            // update the tour stats, if avail
            var srchNum = Ext.get('tourMgmtSearchNum');
            if ( srchNum ) {
              // -1 for the mgmt panel, -1 for the search about to be removed
              var num = me.items.getCount() - 2;

              srchNum.update( num + ' search' + (num!=1?'es':'') );
            }

	    firstPanelSwitch( me.items.get(0), me.items.getCount()>2 );
          },
	  'add': function( me, child, idx ) {
	    firstPanelSwitch( me.items.get(0), idx > 0 );
	  }
        }
      });

      // setup the viewport
      var viewport = new Ext.Viewport({
        layout:'border',
        items:[{
          region:'center',
          deferredRender:false,
          contentEl:'center',
          margins:'0 0 0 0',
          border: false
        },
        eastPanel,{
          region:'south',
          id:'searchPanelDiv',
          collapsible:false,
          split:false,
          height:170,
          margins:'0 0 0 0',
          border: false,
          items:[
            vtour.results
          ]
        }]
      });
      
      // hide the logged-in status until after logging in
      if ( state.get( 'vtour_user', '' ) == '' ) {
        loggedInPanel.hide();
      }
      else {
        loginPanel.hide();

        Ext.get('welcomePanel').update( welcomeTemplate.apply( [state.get('vtour_user')] ) );

        var tourState = state.get( 'vtour_tours', '' );
        if ( tourState != '' ) {
          tourState = tourState.split(/;/);
          var tours = [];
          for ( var i = 0; i < tourState.length; i++ ) {
            tours.push( TourRecord.fromString( tourState[i] ) );
          }

          myTourStore.add( tours );
        }
      }

      viewport.on( {
        'resize': function( obj, adjWidth, adjHeight, rawWidth, rawHeight ){ 
          if ( ol_resize && vtour && vtour.ol_map ) {
	    vtour.setMapHeight();
            ol_resize();
          }
        }
      });

      // add the click handler to the results item
      Ext.fly(vtour.results.el.id).on( 'click',function( e ) {
        e.stopEvent();
        var target = e.getTarget('div.thumb');
        if ( target ) {
          var pos = new OpenLayers.LonLat(
            parseFloat(target.getAttribute( 'ext:position' ).split(',')[0]),
            parseFloat(target.getAttribute( 'ext:position' ).split(',')[1])
          );
          var detail = {
            tags: target.getAttribute( 'ext:tags' ),
            position: pos.transform(vtour.ol_map.displayProjection, vtour.ol_map.projection),
            image: (function(img){
	      var i = new Image();
	      i.src = img;
	      return i;
	    })(target.getAttribute( 'ext:image' ) ),
            title: target.getAttribute( 'ext:title' ),
            page_url: target.getAttribute( 'ext:page_url' )
          }

          var feature = new OpenLayers.Feature.Vector(
            new OpenLayers.Geometry.Point(pos.lon, pos.lat),
            {
              searchElem: vtour.results.activeTab.el.id,
              searchDetail: detail
            }
          );
          
          vtour.showDetail( feature );
        }
      }); 
    });

    vtour.getPhotos = function( adapter, bbox, boxFeature, constraints ) {
      var toDate = constraints.todate || new Date();
      var fromDate = constraints.fromdate || (function(){ 
        var d = new Date(); 
        d.setFullYear( d.getFullYear() - 1 );
        return d;
      })();
      var tags = constraints.tags || '';
      var ppg = constraints.perpage || 10;

      var store = adapter.getStore( bbox, fromDate, toDate, tags, ppg );

      var oneSearchPanel = new Ext.Panel({
        cls:'images-view',
        width:535,
        layout:'fit',
        title:'Search '+(vtour.results.items.length),

        items: new Ext.DataView({
          store: store,
          tpl: adapter.template,
          autoHeight:true,
          multiSelect: true,
          overClass:'x-view-over',
          itemSelector:'div.thumb-wrap',
          emptyText: '',
    
          prepareData: adapter.prepareData
        }),

        bbar: adapter.getToolbar( ppg, store, fromDate, toDate, tags ),

        listeners: {
          // this activate function is eye candy
          'activate': function(p) {
            var layer = vtour.ol_layers['features'];
            var index = vtour.results.items.findIndex( 'id', p.id );
            var feature = (layer.features.slice( index-1, index ))[0];
            var tween = new OpenLayers.Tween();
            tween.start( 
              { t: 255 }, 
              { t: 0 }, 
              20, 
              {
                callbacks: {
                  eachStep: function( val ){ 
                    if( feature ){
                      feature.style.fillOpacity = 0.2 + (val['t'] / 255) * 0.8; 
                      layer.redraw();
                    }
                    else {
                      tween.stop();
                    }
                  }
                }
              }
            ); // end tween.start
          },
          'render': function(rendered){
            vtour.results.fireEvent('render',rendered);
          }
        }
      }); // end ext.panel
    
      boxFeature.attributes.searchElem = oneSearchPanel.id;
      boxFeature.attributes.fromdate = fromDate;
      boxFeature.attributes.todate = toDate;
      boxFeature.attributes.tags = tags;
      boxFeature.attributes.service = constraints.service;

      // show results
      vtour.results.add( oneSearchPanel ).show();

      // up the tour stats, if avail
      var srchNum = Ext.get('tourMgmtSearchNum');
      if ( srchNum ) {
        var num = vtour.results.items.getCount() - 1;

        srchNum.update( num + ' search' + (num!=1?'es':'') );
      }
    };

    vtour.setMapHeight = function(){
      // compute the size of the map div for IE/safari/etc
      var mElem = Ext.get(Ext.get('mapDiv').dom.parentNode.parentNode);
      document.getElementById( 'mapDiv' ).style.height = mElem.getComputedHeight() + 'px';
    }
  </script>
  <style type="text/css">
    html,body,div {
      font-family: 'Tahoma','Arial','Helvetica',sans-serif;
    }
    div#mapLayerSwitcherPanel {
      padding:2px;
    }
    div#searchPanel {
      padding:2px;
    }
    div#searchControl {
      padding:2px;
    }
    div#south {
      padding-top: 1.4em;
      text-align: center;
      font-size: 2em;
      color: #999999;
    }

    /** operation buttons (save/copy/delete) **/
    .opContainer {
      text-align:center;
      font-size:0.75em;
    }
    .opPanel {
      height: 65px;
      width: 65px;
      margin-left:5px;
      margin-right:5px;
    }
    .opPanel img {
      width: 40px;
    }
    .opPanel a {
      text-decoration:none;
    }
    .opPanel div {
      border: 1px solid white;
    }
    .opOver {
      background-color:#eeeeee;
      cursor:pointer;
    }
    .opOver div {
      border-color: #bbbbbb;
    }
    
    /** paging toolbar and dataview **/
    .images-view .x-panel-body{
    	background: white;
    	font: 11px Arial, Helvetica, sans-serif;
    }
    .images-view .thumb{
    	background: #dddddd;
    	padding: 3px;
    }
    .images-view .thumb img{
    	height: 75px;
    	width: 75px;
    }
    .images-view .thumb-wrap{
    	float: left;
    	margin: 4px;
    	margin-right: 0;
    	padding: 2px;
    	width: 81px;
    	overflow: hidden;
    }
    .images-view .thumb-wrap span{
    	display: block;
    	overflow: hidden;
    	text-align: center;
    	white-space: nowrap;
    }

    .images-view .x-view-over{
	background: #efefef;
	border:1px solid #dddddd;
	padding: 1px;
    }

    .images-view .x-view-selected{
        background: #dedede;
    	border:1px solid #cccccc;
    	padding: 1px;
    }
    .images-view .x-view-selected .thumb{
    	background:transparent;
    }

    .images-view .loading-indicator {
    	font-size:11px;
    	background-image:url('../../resources/images/default/grid/loading.gif');
    	background-repeat: no-repeat;
    	background-position: left;
    	padding-left:20px;
    	margin:10px;
    }
    /* Fix for Firefox 3 */
    .x-date-middle {
      width: 160px;
    }
    .x-grid3 table {
      table-layout:fixed;
    }
  </style>
<!-- end ExtJS scripts -->

<!-- OpenLayers scripts -->
  <script type="text/javascript" src="OpenLayers-2.7/lib/Firebug/firebug.js"></script>
  <script type="text/javascript" src="OpenLayers-2.7/OpenLayers.js"></script>
  <script type="text/javascript" src="OpenLayers-2.6/lib/Proj4js/proj4js.js"></script>
  <script type="text/javascript" src="http://api.maps.yahoo.com/ajaxymap?v=3.7&appid=APP-ID"></script>
  <script type="text/javascript" src="http://maps.google.com/maps?file=api&v=2.82&key=GMAP-KEY"></script>
  <script type="text/javascript">
    function ol_init(){
      Proj4js.libPath = 'OpenLayers-2.6/lib/Proj4js/';
      var options = {
        projection: new OpenLayers.Projection('EPSG:900913'),
        displayProjection: new OpenLayers.Projection('EPSG:4326'),
        units: 'm',
        maxResolution: 156543.0339,
        maxExtent: new OpenLayers.Bounds( -20037508, -20037508, 20037508, 20037508.34 )
      };

      vtour.searchService = 'flickr';
      vtour.boxWidth = 20;
      vtour.setMapHeight();

      vtour.geojson = new OpenLayers.Format.GeoJSON({
        externalProjection:options.displayProjection,
        internalProjection:options.projection
      });

      vtour.ol_map = new OpenLayers.Map('mapDiv', options);

      vtour.ol_map.addControl(new OpenLayers.Control.KeyboardDefaults());

      vtour.ol_layers = {
        yahoo: new OpenLayers.Layer.Yahoo( "Yahoo", { sphericalMercator: true } ),
        google: new OpenLayers.Layer.Google( "Google", { sphericalMercator: true } ),
        features: new OpenLayers.Layer.Vector('Bounding Boxes'),
        markers: new OpenLayers.Layer.Vector(
          "Marker Drop Shadows",
          {
            styleMap: new OpenLayers.StyleMap({
              'default': {
                // Set the external graphic and background graphic images.
                externalGraphic: "OpenLayers-2.6/img/marker-gold.png",
                backgroundGraphic: "OpenLayers-2.6/img/marker_shadow.png",

                graphicXOffset: -10,
                graphicYOffset: -21,
                
                // Makes sure the background graphic is placed correctly relative
                // to the external graphic.
                backgroundXOffset: 0,
                backgroundYOffset: -17,
                
                // Set the z-indexes of both graphics to make sure the background
                // graphics stay in the background (shadows on top of markers looks
                // odd; let us not do that).
                graphicZIndex: 101,
                backgroundGraphicZIndex: 100,
                
                pointRadius: 10
              },
              select: {
                externalGraphic: "OpenLayers-2.6/img/marker-green.png",
                pointRadius: 10
              }
            }),
            isBaseLayer: false,
            rendererOptions: {yOrdering: true}
          }
        )
      };

      //
      // select photo items
      //
      selectControl = new OpenLayers.Control.SelectFeature(
        vtour.ol_layers['markers'],
        {
          onSelect: function (feature) {
	    // feature has an attribute 'searchDetail' that contains:
	    // title, position, tags, image
            var detail = feature.attributes.searchDetail;

            var tagStr = '';
            if ( detail.tags ) {
		tagStr = '<p class="detail"><span class="detail">tags</span>:' + detail.tags + '</p>';
            }
            var popup = new OpenLayers.Popup.FramedCloud(
              "photo", 
              feature.geometry.getBounds().getCenterLonLat(),
              null,
              '<div style="width:' + (detail.image.width+6) + 'px;" class="detail">' +
		'<h2 class="detail">' + detail.title +  '</h2>' +
                '<div><input type="checkbox" id="' + feature.id + '_delme" name="' + feature.id + '_delme"/> ' + 
                '<label for="' + feature.id + '_delme">hide</label></div>' +
		'<img src="' + detail.image.src + '" alt="' + detail.title +
		'" title="' + detail.title + '" width="' + detail.image.width +
		'" height="' + detail.height + '" class="detail"/>' +
		'<div class="detaillink"><a href="' + detail.page_url +
                '" target="_blank" class="detail">photopage</a></div>' +
                tagStr + '</div>',
              null, 
              true, 
              function (evt) {
                var chk = Ext.get(feature.id+'_delme'); 
                var remove = chk.dom.checked;
                OpenLayers.Event.stop(evt);
                selectControl.unselect(feature);

                if (remove) { 
                  vtour.ol_layers['markers'].removeFeatures( [feature] );
                  
                  // update the tour stats, if avail
                  var resNum = Ext.get('tourMgmtResultNum');
                  if ( resNum ) {
                    var num = vtour.ol_layers['markers'].features.length;

                    resNum.update( num + ' result' + (num!=1?'s':'') );
                  }
                }
              }
            );
              
            feature.popup = popup;
            vtour.ol_map.addPopup(popup);
          }, 
          onUnselect: function (feature) {
            vtour.ol_map.removePopup(feature.popup);
            feature.popup.destroy();
            feature.popup = null;
          }
        }
      );
      
      vtour.ol_map.addControl(selectControl);
      selectControl.activate();
      //
      // end of select photo items
      //

      for ( var key in vtour.ol_layers )
      {
        vtour.ol_map.addLayer( vtour.ol_layers[key] );
      }

      vtour.ol_map.setCenter(new OpenLayers.LonLat(-8367155.413500762,4859078.000840925), 12);

      vtour.ol_map.events.register('click', vtour.ol_map, focusRegion );
    }

    function ol_resize() {
      vtour.ol_map.updateSize();
    }

    function changeLayer( element ) {
      vtour.ol_map.setBaseLayer( vtour.ol_layers[ element.value ] );
    }

    function changeRadius( element ) {
      vtour.boxWidth = element.value * 2;
    }

    function changeService( element ) {
      vtour.searchService = element.value;
    }

    function focusRegion(e) {
      var lonlat = vtour.ol_map.getLonLatFromPixel(e.xy);
      var bounds = vtour.ol_map.getExtent();

      var sz = Math.min( bounds.getWidth(), bounds.getHeight() ) / vtour.boxWidth;

      var myBounds = new OpenLayers.Bounds( lonlat.lon-sz, lonlat.lat-sz,
	lonlat.lon+sz, lonlat.lat+sz );
      
      var rectangle = myBounds.toGeometry();
      var polygonFeature = new OpenLayers.Feature.Vector(
        rectangle, { searchElem: '' }, {
          fillColor: '#fff',
          fillOpacity: 0.2,
          strokeColor: '#333',
          strokeOpacity: 0.5,
          strokeWidth: 1,
          strokeLinecap: 'round'
        });

      vtour.ol_layers['features'].addFeatures([polygonFeature]);

      var prjBounds = myBounds.transform(
        vtour.ol_map.projection,
        vtour.ol_map.displayProjection
      );

      // get settings from the UI
      var datefrm = vtour.datePanel.getForm();
      var tagfrm = vtour.tagPanel.getForm();

      var constraints = {
        perpage: Math.floor(vtour.results.activeTab.el.getWidth()/93),
        fromdate: datefrm.findField('fromDate').getValue(),
        todate: datefrm.findField('toDate').getValue(),
        tags: tagfrm.findField('tagFilter').getValue(),
        service: vtour.searchService
      };
      
      var adapter = vtour.adapters[vtour.searchService];
      vtour.getPhotos( adapter, prjBounds.toBBOX(), polygonFeature, constraints );
    };

    vtour.showDetail = function( feature ) {
      // attach to the feature layer
      vtour.ol_layers['markers'].addFeatures( [feature] );

      // update the tour stats, if avail
      var resNum = Ext.get('tourMgmtResultNum');
      if ( resNum ) {
        var num = vtour.ol_layers['markers'].features.length;

        resNum.update( num + ' result' + (num!=1?'s':'') );
      }
    }

    vtour.saveTour = function( id, name, date, success, failure ) {
      // create a bounding box, that would be the bounds of all searches
      var allBounds = new OpenLayers.Bounds();
      var feature = null;
      for( var i = 0; i < vtour.ol_layers['features'].features.length; i++ ) {
        feature = vtour.ol_layers['features'].features[i];
        allBounds.extend(feature.geometry.getBounds());
      }

      feature = new OpenLayers.Feature.Vector( allBounds.toGeometry(), {
        user_id: id,
        name: name,
        date: date.format('Y-m-d'),
        public: false
      });

      OpenLayers.Request.issue({
        url: vtour.fsurl + '/tour',
        params: { format:'geojson' },
	method: 'POST', 
	data: vtour.geojson.write(feature),
	headers: {'Accept': 'application/json'},
	async: false,
	success: success,
	failure: failure
      });
    };

    vtour.deleteTour = function( id, success, failure ) {
      var wait = Ext.MessageBox.wait( 'Deleting...' );
      var fail = false;
      // delete all results 1st
      for( var i=0; i< vtour.ol_layers['markers'].features.length; i++ ) {
        var result = vtour.ol_layers['markers'].features[i];
        OpenLayers.Request.issue({
          url:vtour.fsurl + '/result/' + result.fid,
          method:'DELETE',
          headers: { 'Accept':'application/json' },
          async: false,
          success: function(){ OpenLayers.Console.debug( '    deleted  result ' + result.fid ); },
          failure: function(){ 
            fail = true;
            OpenLayers.Console.debug( 'ERR deleting result ' + result.fid ); 
          }
        });
      }

      // delete all searches 2nd
      for ( var i=0; i<vtour.ol_layers['features'].features.length; i++ ) {
        var search = vtour.ol_layers['features'].features[i];
        OpenLayers.Request.issue({
          url:vtour.fsurl + '/search/' + search.fid,
          method:'DELETE',
          headers: {'Accept':'application/json' },
          async: false,
          success: function(){ OpenLayers.Console.debug( '    deleted  search ' + search.fid ); },
          failure: function(){ 
            fail = true;
            OpenLayers.Console.debug( 'ERR deleting search ' + search.fid ); 
          }
        });
      }
      
      OpenLayers.Request.issue({
        url:vtour.fsurl + '/tour/' + id,
        method: 'DELETE',
        headers: { 'Accept':'application/json' },
        async: false,
        success: function(){ OpenLayers.Console.debug( '    deleted  tour ' + id ); },
        failure: function(){ 
          fail = true;
          OpenLayers.Console.debug( 'ERR deleting tour '+ id ); 
        } 
      });

      wait.hide();

      if ( fail ) {
        failure();
      }
      else {
        success( id );
      }
    };

    vtour.saveSearch = function( userId, tourId, feature, success, failure ) {
      var feat = new OpenLayers.Feature.Vector( feature.geometry, {
        'user_id': userId,
        tour: tourId,
        fromdate: feature.attributes['fromdate'],
        todate: feature.attributes['todate'],
        tags: feature.attributes['tags'],
        service: feature.attributes['service']
      } );

      OpenLayers.Request.issue({
        url: vtour.fsurl + '/search',
        params: { format: 'geojson' },
        method: 'POST',
        data: vtour.geojson.write(feat),
        headers: { 'Accept': 'application/json' },
        async: false,
        success: success,
        failure: failure
      });
    };

    vtour.saveResult = function( userId, searchId, details, geometry, success, failure ) {
      // create a point
      var center = geometry.getBounds().getCenterLonLat();
      var feat = new OpenLayers.Feature.Vector(
        new OpenLayers.Geometry.Point( center.lon, center.lat ),
        {
          user_id: userId,
          search: searchId,
          thumb_url: details.image.src,
          name: details.title,
          page_url: details.page_url
        }
      );

      OpenLayers.Request.issue({
        url: vtour.fsurl + '/result',  
        method: 'POST',
        data: vtour.geojson.write(feat),
        headers: {'Accept': 'application/json'},
        async: false,
        success: success,
        failure: failure
      });
    };
  </script>
  <style type="text/css">
    div#mapDiv {
      height:100%;
      width:100%;
    }
    div.detail {
      padding: 5px;
    }
    h2.detail {
    }
    p.detail {
      color:#666666;
      font-size:0.75em;
      padding:2px;
    }
    img.detail {
    }
    span.detail {
      font-weight:bold;
    }
    div.detaillink {
      text-align:right;
    }
    a.detail {
      font-size:0.7em;
    }
    div.detail label {
      font-size:0.7em;
      vertical-align:top;
    }
    div.detail div {
      text-align:right;
    }
  </style>
<!-- end OpenLayers scripts -->
</head>
<body onload="ol_init();">
  <div id="center">
    <div id="mapDiv">
    </div>
  </div>
  <div id="mapLayerSwitcherPanel" class="x-hidden">
    <ul>
      <li>
        <input type="radio" name="olLayerName" value="yahoo" onclick="changeLayer(this);" id="yml" checked="checked"/>
        <label for="yml">Yahoo</label>
      </li>
      <li>
        <input type="radio" name="olLayerName" value="google" onclick="changeLayer(this);" id="gml"/>
        <label for="gml">Google</label>
      </li>
    </ul>
  </div>
  <div id="searchPanel" class="x-hidden">
    <ul>
      <li>
        <input type="radio" name="searchRadius" value="20" onclick="changeRadius(this);" id="sr1" />
        <label for="sr1">Small</label>
      </li>
      <li>
        <input type="radio" name="searchRadius" value="10" checked="checked" onclick="changeRadius(this);" id="sr2"/>
        <label for="sr2">Medium</label>
      </li>
      <li>
        <input type="radio" name="searchRadius" value="5" onclick="changeRadius(this);" id="sr3" /> 
        <label for="sr3">Large</label>
      </li>
    </ul>
  </div>
  <div id="saveBtnPanel"><img src="gtk-save.png"/><br/>Save</div>
  <div id="clrBtnPanel"><img src="gnome-stock-import.png"/><br/>Clear</div>
  <div id="delBtnPanel"><img src="gtk-clear.png"/><br/>Delete</div>
  <div id="south">
    <p>Click on the map to search for photos.</p>
  </div>
 </body>
</html>
